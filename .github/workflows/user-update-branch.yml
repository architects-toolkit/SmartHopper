name: üë§üîÑ Update Branch

# Description: This workflow updates a target branch with changes from an origin branch.
# If the merge has no conflicts, it will automatically merge the changes.
# If there are conflicts, it will create a pull request for manual resolution.
#
# This workflow is manually triggered and requires specifying the origin and target branches.
#
# Triggers:
# - Manually via workflow_dispatch with origin and target branch inputs
#
# Permissions:
# - contents:write - Required to create branches and commit changes
# - pull-requests:write - Required to create pull requests

on:
  workflow_dispatch:
    inputs:
      origin_branch:
        description: 'Origin branch (source of changes)'
        required: true
        type: string
      target_branch:
        description: 'Target branch (to be updated)'
        required: true
        type: string
      filter:
        description: 'Specific folder to update (e.g., .github or src/SmartHopper.Components). Leave blank to update all code.'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Validate branches
        id: validate-branches
        run: |
          # Check if origin branch exists
          if ! git ls-remote --heads origin ${{ github.event.inputs.origin_branch }} | grep -q ${{ github.event.inputs.origin_branch }}; then
            echo "::error::Origin branch '${{ github.event.inputs.origin_branch }}' does not exist."
            exit 1
          fi
          
          # Check if target branch exists
          if ! git ls-remote --heads origin ${{ github.event.inputs.target_branch }} | grep -q ${{ github.event.inputs.target_branch }}; then
            echo "::error::Target branch '${{ github.event.inputs.target_branch }}' does not exist."
            exit 1
          fi
          
          # Check if branches are the same
          if [[ "${{ github.event.inputs.origin_branch }}" == "${{ github.event.inputs.target_branch }}" ]]; then
            echo "::error::Origin and target branches cannot be the same."
            exit 1
          fi
          
          echo "Branches validated successfully."
        shell: bash

      - name: Check for existing PR
        id: check-existing-pr
        uses: actions/github-script@v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prTitle = `chore(branch): update ${{ github.event.inputs.target_branch }} from ${{ github.event.inputs.origin_branch }}`;
            
            console.log(`Checking for existing PRs with title: ${prTitle}`);
            
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: '${{ github.event.inputs.target_branch }}'
            });
            
            const existingPR = prs.data.find(pr => 
              pr.title === prTitle && 
              pr.head.ref.includes('update-branch')
            );
            
            if (existingPR) {
              console.log(`Found existing PR: #${existingPR.number} (${existingPR.html_url})`);
              return {
                exists: true,
                pr_number: existingPR.number,
                pr_url: existingPR.html_url
              };
            } else {
              console.log('No existing PR found');
              return {
                exists: false
              };
            }

      - name: Exit if PR exists
        if: fromJSON(steps.check-existing-pr.outputs.result).exists == true
        run: |
          echo "::warning::An open PR already exists for updating ${{ github.event.inputs.target_branch }} from ${{ github.event.inputs.origin_branch }}. See PR #$(echo '${{ steps.check-existing-pr.outputs.result }}' | jq -r .pr_number) at $(echo '${{ steps.check-existing-pr.outputs.result }}' | jq -r .pr_url)"
          exit 0
        shell: bash

      - name: Create temporary branch
        id: create-temp-branch
        run: |
          # Create a unique branch name
          TEMP_BRANCH="update-branch/${{ github.event.inputs.target_branch }}-from-${{ github.event.inputs.origin_branch }}-$(date +%s)"
          echo "temp_branch=$TEMP_BRANCH" >> $GITHUB_OUTPUT
          # Checkout target branch
          git checkout ${{ github.event.inputs.target_branch }}
          # Create temporary branch from target
          git checkout -b $TEMP_BRANCH
          echo "Created temporary branch: $TEMP_BRANCH"
        shell: bash

      - name: Perform update
        id: perform-update
        run: |
          ORIGIN=${{ github.event.inputs.origin_branch }}
          TARGET=${{ github.event.inputs.target_branch }}
          FILTER=${{ github.event.inputs.filter }}
          if [ -z "$FILTER" ]; then
            echo "Merging origin/$ORIGIN into $TARGET..."
            if git merge origin/$ORIGIN --no-ff; then
              echo "Merge successful, no conflicts detected."
              echo "Checking for any changes..."
              if git diff --quiet origin/$TARGET origin/$ORIGIN; then
                echo "No changes to merge. Branches are already in sync."
                echo "::set-output name=status::no_changes::true"
                exit 0
              fi
              echo "::set-output name=status::success::true"
            else
              echo "Merge conflicts detected. Will create a PR for manual resolution."
              git merge --abort
              echo "::set-output name=status::conflict::true"
              exit 0
            fi
          else
            echo "Updating specific path: $FILTER"
            git checkout origin/$ORIGIN -- "$FILTER"
            if git diff --quiet; then
              echo "No changes to merge for path $FILTER."
              echo "::set-output name=status::no_changes::true"
              exit 0
            fi
            echo "Committing changes for path $FILTER"
            git add "$FILTER"
            git commit -m "chore(branch): update $TARGET from $ORIGIN for path $FILTER"
            echo "::set-output name=status::success::true"
          fi
        shell: bash

      - name: Publish updates
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TMP_BRANCH=${{ steps.create-temp-branch.outputs.temp_branch }}
          TARGET=${{ github.event.inputs.target_branch }}
          ORIGIN=${{ github.event.inputs.origin_branch }}
          FILTER=${{ github.event.inputs.filter }}
          STATUS=${{ steps.perform-update.outputs.status }}
          if [ "$STATUS" = "no_changes" ]; then
            echo "‚ÑπÔ∏è No changes to merge. Nothing to do."
            exit 0
          fi
          if [ "$STATUS" = "success" ]; then
            if git push origin $TMP_BRANCH:$TARGET; then
              echo "‚úÖ Successfully updated $TARGET with changes from $ORIGIN."
              exit 0
            else
              echo "‚ÑπÔ∏è Direct push failed. Branch may be protected. Creating a PR..."
            fi
          elif [ "$STATUS" = "conflict" ]; then
            echo "‚ö†Ô∏è Merge conflicts detected. Creating a PR for manual resolution..."
          fi
          # Build PR body
          prBody="## Branch Update

          This PR updates \\`$TARGET\\` with changes from \\`$ORIGIN\\`."
            if [ "$STATUS" = "conflict" ]; then
              prBody+="

                ### ‚ö†Ô∏è Merge Conflicts

                This PR contains merge conflicts that need to be resolved manually."
            else
              prBody+="

                ### ‚ÑπÔ∏è Protected Branch

                This PR was created because \\`$TARGET\\` is a protected branch that requires changes through pull requests."
            fi
          prBody+="

            ### Instructions

            1. $( [ "$STATUS" = "conflict" ] && echo 'Resolve the conflicts in this PR' || echo 'Review the changes' )
            2. Approve and merge the changes

            This PR was automatically created by the Branch Update workflow."

          # Create PR
          prUrl=$(gh pr create \
            --title "chore(branch): update $TARGET from $ORIGIN" \
            --body "$prBody" \
            --head $TMP_BRANCH --base $TARGET)
          echo "$prUrl"
        shell: bash
