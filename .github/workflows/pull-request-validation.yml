name: Pull Request Validation

on:
  pull_request:
    branches: 
      - main
      - dev

permissions:
  contents: read
  pull-requests: read

jobs:
  version-check:
    name: 📦 Version Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate Version in Solution.props
        run: |
          VERSION=$(grep -oP '(?<=<SolutionVersion>)[^<]+' Solution.props)
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[0-9]+)?)?$ ]]; then
            echo "Invalid version format in Solution.props ($VERSION). Must follow semantic versioning."
            exit 1
          fi

  changelog-check:
    name: 📝 Changelog Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4

      - name: Check CHANGELOG.md is Updated
        uses: tj-actions/changed-files@v46.0.1
        id: changelog-check
        with:
          files: CHANGELOG.md

      - name: Validate Changelog Update
        if: steps.changelog-check.outputs.any_changed != 'true'
        env:
          CHANGED_FILES: ${{ steps.changelog-check.outputs.all_changed_files }}
        run: |
          echo "Error: CHANGELOG.md must be updated with pull request changes"
          exit 1

  title-check:
    name: 🏷️ PR Title Style Check
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Validate PR Title Style
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! $PR_TITLE =~ ^(feat|fix|docs|style|refactor|test|chore)(\([a-z]+\))?:.+ ]]; then
            echo "Error: Pull request title must follow conventional commits format"
            echo "Current title: $PR_TITLE"
            echo "Example formats:"
            echo "  feat: add new feature"
            echo "  fix(component): resolve specific issue"
            echo "  docs(readme): update documentation"
            exit 1
          fi
